<!-- <link href="__INDEX__/layuiadmin/step-lay/step.css" rel="stylesheet"> -->
    <body>
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                              <legend>添加房屋{$info['uuid']}的入住信息</legend>
                            </fieldset>
                            <div class="layui-card-body" style="padding-top: 40px;">

                                <form id="form" class="layui-form layui-form-pane" action="" style="max-width: 995px;">
                                    <input type="hidden" name="uuid" value="{$info['uuid']}">
                                    <input type="hidden" name="room_id" value="{$info['room_id']}">
                                    
                                    <div class="layui-form-item" pane="">
                                        <label class="layui-form-label">选择状态</label>
                                        <div class="layui-input-block" id="ishousestate">
                                            <input type="radio" name="housestate" value="在租" title="入住" lay-filter="clik" checked="">
                                            <input type="radio" name="housestate" value="预定" title="预定" lay-filter="clik">
                                        </div>
                                    </div>
                                    <div class="layui-form-item price" style="display: none;">
                                        <label class="layui-form-label">收租金额</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="rental" value='0' lay-verify="required" placeholder="收租金额" autocomplete="off" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">元/月</div>
                                    </div>
                                    <div class="layui-form-item deposit">
                                        <label class="layui-form-label">租房押金</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="deposit" lay-verify="required" placeholder="租房押金" autocomplete="off" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux"></div>
                                    </div>
                                    <!-- =============================================附加信息======================= -->
                                    <div class="layui-form-item yudingpri" style="display: none;">
                                        <label class="layui-form-label">预定金</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="yudingpri" placeholder="预定金" autocomplete="off" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">元</div>
                                    </div>
                                    <div class="layui-form-item username">
                                        <label class="layui-form-label">承租人姓名</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][username]" lay-verify="username" autocomplete="off" placeholder="租客姓名" class="layui-input usernames">
                                        </div>
                                    </div>
                                    <div class="layui-form-item sex" pane="">
                                        <label class="layui-form-label">承租人性别</label>
                                        <div class="layui-input-block">
                                            <input type="radio" name="user[0][sex]" value="1" title="男" checked="">
                                            <input type="radio" name="user[0][sex]" value="2" title="女">
                                        </div>
                                    </div>
                                    <div class="layui-form-item userphone">
                                        <label class="layui-form-label">手机号码</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][userphone]" lay-verify="phone" autocomplete="off" placeholder="租客手机号码" class="layui-input userphones">
                                        </div>
                                    </div>
                                    <div class="layui-form-item usercard">
                                        <label class="layui-form-label">证件号</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][usercard]" autocomplete="off" placeholder="租客证件号(身份证、等)，没有不填" class="layui-input usercards">
                                        </div>
                                    </div>
                                    <div class="layui-form-item nation">
                                        <label class="layui-form-label">籍贯</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][nation]" autocomplete="off" placeholder="籍贯" class="layui-input nation">
                                        </div>
                                    </div>
                                    <div class="layui-form-item address">
                                        <label class="layui-form-label">籍贯地址</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][address]" autocomplete="off" placeholder="籍贯" class="layui-input address">
                                        </div>
                                    </div>
                                    <div class="layui-form-item authority" style="display: none;">
                                        <label class="layui-form-label">签发机关</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][authority]" autocomplete="off" placeholder="籍贯" class="layui-input authority">
                                        </div>
                                    </div>
                                    <div class="layui-form-item validdate" style="display: none;">
                                        <label class="layui-form-label">证件有效期</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][validdate]" autocomplete="off" placeholder="籍贯" class="layui-input validdate">
                                        </div>
                                    </div>
                                    <div class="layui-form-item huzhao">
                                        <label class="layui-form-label">护照号</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="user[0][huzhao]" autocomplete="off" placeholder="租客证件号(护照)，没有不填" class="layui-input huzhao">
                                        </div>
                                    </div>
                                    <fieldset class="layui-elem-field adduserlist" style="display: none;">
                                        <legend>增加的租客信息</legend>
                                        <div class="layui-field-box listInput">
                                            
                                        </div>
                                    </fieldset>
                                    <div class="layui-form-item useradd">
                                        <button id="useradd" type="button" class="layui-btn layui-btn-primary layui-btn-radius" data-type="adds">+ 增加一人</button>
                                    </div>
                                    <div class="layui-form-item useradd">
                                        <style type="text/css">
                                          .layui-upload-drag{
                                            padding: 10px;
                                          }
                                        </style>
                                        <div class="layui-col-md12">
                                          <div class="layui-card">
                                            <div class="layui-card-header">承租人证件照</div>
                                            <div class="layui-card-body">
                                                <input type="hidden" name="chengzhuren_zhengmian" id="chengzhuren_zhengmian" value="">
                                                <input type="hidden" name="chengzhuren_fanmian" id="chengzhuren_fanmian" value="">
                                              <div class="layui-upload">
                                                <div class="layui-upload-drag" id="test-upload-normal1">
                                                  <img class="zhengmm" src="__CDN__/assets/img/zhengm.png" style="width:90px;height:100px;">
                                                </div>
                                                <div class="layui-upload-drag" id="test-upload-normal2">
                                                  <img class="fanmm" src="__CDN__/assets/img/fanm.png" style="width:90px;height:100px;">
                                                </div>
                                                <div class="layui-upload-drag" style="border: none;">
                                                  <p>或者</p>
                                                </div>

                                                <div class="layui-upload-drag" style="padding: 5px;">
                                                  <img src="{:url('index/House/create',array('rands'=>$rands))}" style="width: 102px;">
                                                </div>
                                              </div> 
                                              <br>
                                              <blockquote class="layui-elem-quote">
                                                <p>上传承租人身份证照片，会自动识别承租人信息，并填入上面承租人信息 </p>
                                                <p>如果上传错误，请直接点击图片选择正确的照片，重新上传！谢谢 </p>
                                                <p>注意：当前只能识别身份证信息，无法识别护照信息</p>
                                              </blockquote>   
                                            </div>
                                          </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item pricemodel">
                                        <label class="layui-form-label">清单模板</label>
                                        <div class="layui-input-inline">
                                            <select name="listtemplate" lay-verify="required" lay-search="" lay-filter="listtemplate">
                                            <option value="">请选择入住清单模板</option>
                                            {foreach $listName as $key=>$vo } 
                                                <option value="{$vo.id}">{$vo.modelName}</option>
                                            {/foreach}
                                            </select>
                                        </div>
                                    </div>
                                    <fieldset class="layui-elem-field showlisttemplateContent layui-anim layui-anim-upbit" style="display: none;">
                                        <legend>清单配置</legend>
                                        <div class="layui-field-box listtemplateContent">
                                            <div class="layui-card-header">清单配置：</div>
                                            <div class="layui-card-body" style="padding: 5px;" id="guDingFree2">
                                                  
                                            </div>
                                            <div class="layui-card-header" style="display: none;">计量费用：</div>
                                            <div class="layui-card-body" style="padding: 5px;" id="jiLiangFree2">
                                                
                                            </div>
                                        </div>
                                    </fieldset>
                                    <div class="layui-form-item pricemodel">
                                        <label class="layui-form-label">费用模板</label>
                                        <div class="layui-input-inline">
                                            <select name="pricemodel" lay-verify="required" lay-search="" lay-filter="pricemodel">
                                            <option value="">请选择费用信息模板</option>
                                            {foreach $modelName as $key=>$vo } 
                                                <option value="{$vo.id}">{$vo.modelName}</option>
                                            {/foreach}
                                            </select>
                                        </div>
                                    </div>
                                    <fieldset class="layui-elem-field showPricemodelContent layui-anim layui-anim-upbit" style="display: none;">
                                        <legend>费用配置</legend>
                                        <div class="layui-field-box pricemodelContent">
                                            <div class="layui-card-header">固定费用：</div>
                                            <div class="layui-card-body" style="padding: 5px;" id="guDingFree">
                                                  
                                            </div>
                                            <div class="layui-card-header" style="display: none;">计量费用：</div>
                                            <div class="layui-card-body" style="padding: 5px;" id="jiLiangFree">
                                                
                                            </div>
                                        </div>
                                    </fieldset>
                                    <div class="layui-form-item renttimes">
                                        <label class="layui-form-label">租赁时间</label>
                                        <!-- <div class="layui-input-inline">
                                            <input type="text" class="layui-input" id="test-laydate-range-date" placeholder=" ~ ">
                                        </div> -->
                                        <div class="layui-input-inline" style="margin-right: -1px;">
                                            <input type="text" name="startimes" class="layui-input test-laydate-range-date-star" lay-verify="required" id="test-laydate-range-date-star" placeholder=" 开始时间 ">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux test-laydate-range-date-star" style="border:1px solid #e6e6e6;padding: 7.5px 7.5px!important;background: #eee;">
                                            <i class="layui-icon layui-icon-date" style="color: red;font-weight: bold;"></i>
                                        </div>
                                            <div class="layui-form-mid layui-word-aux">到</div>
                                        <div class="layui-input-inline" style="margin-right: -1px;">
                                            <input type="text" name="endtimes" class="layui-input test-laydate-range-date-end" lay-verify="required" id="test-laydate-range-date-end" placeholder=" 结束时间 ">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux test-laydate-range-date-end" style="border:1px solid #e6e6e6;padding: 7.5px 7.5px!important;background: #eee;">
                                            <i class="layui-icon layui-icon-date" style="color: red;font-weight: bold;"></i>
                                        </div>
                                    </div>
                                    <div class="layui-form-item paymentway" pane="">
                                        <label class="layui-form-label">付款周期</label>
                                        <div class="layui-input-block">
                                            <input type="radio" name="paymenttimes" value="月付" title="月付" checked="">
                                            <input type="radio" name="paymenttimes" value="季付" title="季付">
                                            <input type="radio" name="paymenttimes" value="半年付" title="半年付">
                                            <input type="radio" name="paymenttimes" value="年付" title="年付">
                                        </div>
                                    </div>
                                    <div class="layui-form-item userorigin">
                                        <label class="layui-form-label">租客来源</label>
                                        <div class="layui-input-inline">
                                            <select name="userorigin" lay-verify="required" lay-search="">
                                            <option value="">请选择租客来源</option>
                                            {foreach $rent_source as $key=>$vo } 
                                                <option value="{$vo.id}">{$vo.source}</option>
                                            {/foreach} 
                                            </select>
                                        </div>
                                    </div>
                                    <!-- =============================================附加信息 END======================= -->

                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                          <button class="layui-btn" lay-submit="" lay-filter="subs" id="subs">立即添加</button>
                                          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                        </div>
                                    </div>
                                    
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <script src="__INDEX__/layuiadmin/layui/layui.js"></script>
        <script>
            layui.config({
                base: '__INDEX__/layuiadmin/' //静态资源所在路径
            }).extend({
                index: 'lib/index' //主入口模块
            }).use(['form','laydate','index', 'upload'],function(){
                var laydate = layui.laydate;
                var $ = layui.$
                , layer = layui.layer
                , upload = layui.upload
                // element.render();
                
                //点击增加一位租客
                $('.useradd #useradd').on('click', function(){
                    var numbers = $('.isusernum').length;
                    var index = numbers + 1;
                    var html = '<fieldset class="layui-elem-field isusernum">\
                                    <legend class="dels" style="color: red;margin-left:50px;font-size: 16px;cursor: pointer;">删除</legend>\
                                    <div class="layui-field-box">\
                                        <div class="layui-form-item username">\
                                            <label class="layui-form-label">同住人姓名</label>\
                                            <div class="layui-input-block">\
                                                <input type="text" name="user['+index+'][username]" lay-verify="username" autocomplete="off" placeholder="租客姓名" class="layui-input usernames">\
                                            </div>\
                                        </div>\
                                        <div class="layui-form-item sex" pane="">\
                                        <label class="layui-form-label">同住人性别</label>\
                                        <div class="layui-input-block">\
                                            <input type="radio" name="user['+index+'][sex]" value="1" title="男" checked=""/>\
                                            <input type="radio" name="user['+index+'][sex]" value="2" title="女"/>\
                                        </div>\
                                    </div>\
                                        <div class="layui-form-item userphone">\
                                            <label class="layui-form-label">手机号码</label>\
                                            <div class="layui-input-block">\
                                                <input type="text" name="user['+index+'][userphone]" lay-verify="phone" autocomplete="off" placeholder="租客手机号码" class="layui-input userphones">\
                                            </div>\
                                        </div>\
                                        <div class="layui-form-item usercard">\
                                            <label class="layui-form-label">证件号</label>\
                                            <div class="layui-input-block">\
                                                <input type="text" name="user['+index+'][usercard]" autocomplete="off" placeholder="租客身份证号，没有不填" class="layui-input usercards">\
                                            </div>\
                                        </div>\
                                        <div class="layui-form-item huzhao">\
                                            <label class="layui-form-label">护照号</label>\
                                            <div class="layui-input-block">\
                                                <input type="text" name="user[0][huzhao]" autocomplete="off" placeholder="租客证件号(护照，没有不填)" class="layui-input huzhao">\
                                            </div>\
                                        </div>\
                                    </div>\
                                </fieldset>';

                    if(numbers >= 4){
                        layer.msg('最多新增四个租客！', {icon: 5});
                        return false;
                    }else{
                        $('.listInput').append(html);
                        $(".adduserlist").show();
                        form.render();
                    }
                    
                });
                

                $(document).on("click",".dels",function(){
                    var numbers = $('.isusernum').length;
                    var objs = $(this);
                    layer.confirm('是否取消新增租客？', {
                        btn: ['确定','取消'] //按钮
                    }, function(){
                        if(numbers == 1){
                            objs.parent().remove();
                            $(".adduserlist").hide();
                        }else{
                            objs.parent().remove();
                        }
                        layer.msg('已取消新增', {icon: 1});
                    }, function(){
                        // layer.msg('已取消', {
                        //     time: 1000
                        // });
                    }); 
                })


                //start日期范围
                laydate.render({
                  elem: '#test-laydate-range-date'
                  ,range: true
                });

                laydate.render({
                    elem: '.test-laydate-range-date-star',
                    format: 'yyyy-MM-dd',
                });

                laydate.render({
                    elem: '.test-laydate-range-date-end',
                    format: 'yyyy-MM-dd',
                });

                // 设置最小可选的日期
                function minDate(){
                    var now = new Date();
                    return now.getFullYear()+"-" + (now.getMonth()+1) + "-" + now.getDate();
                }
                function endminDate(){
                    var now = new Date();
                    return now.getFullYear()+"-" + (now.getMonth()+1) + "-" + now.getDate();
                }

                //end日期范围
                var form = layui.form;

                // 基本验证
                form.verify({
                  username: function(value, item){ //value：表单的值、item：表单的DOM对象
                    if(!value){
                      return '租客姓名不能为空';
                    }
                    if(!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)){
                      return '用户名不能有特殊字符';
                    }
                    if(/(^\_)|(\__)|(\_+$)/.test(value)){
                      return '用户名首尾不能出现下划线\'_\'';
                    }
                    if(/^\d+\d+\d$/.test(value)){
                      return '用户名不能全为数字';
                    }
                  }
                });
    
                // 房屋状态判断，入住、预定
                form.on('radio(clik)', function (data) {
                    
                    if($('#ishousestate input[name="housestate"]:checked ').val() == "预定"){
                        $('.deposit').hide();
                        $('input[name="deposit"]').removeAttr("lay-verify");
                        $('.yudingpri').show();
                        $('input[name="yudingpri"]').attr("lay-verify","required");

                        $(".paymentway").hide();

                        $(".renttimes").hide();
                        $('input[name="endtimes"]').removeAttr("lay-verify");
                        $('input[name="startimes"]').removeAttr("lay-verify");
                        $(".pricemodel").show();
                        $('select[name="pricemodel"]').attr("lay-verify","required");
                        $(".huzhao").show();
                        $('.huzhao').removeAttr("lay-verify");
                        $(".usercard").show();
                        $('.usercards').removeAttr("lay-verify","identity");
                        $(".userphone").show();
                        $('.userphones').attr("lay-verify","phone");
                        $(".username").show();
                        $('.usernames').attr("lay-verify","username");
                        $('.sex').show();
                        $(".userorigin").show();
                        $('select[name="userorigin"]').attr("lay-verify","required");
                        
                        $(".useradd").show();
                        var showPricemodelContentnumbers = $('.afixFeesLen').length;
                        if(showPricemodelContentnumbers > 0){
                            $('.showPricemodelContent').show();
                        }else{
                            $('.showPricemodelContent').hide();
                        }

                        var showlisttemplateContentnumbers = $('.afixFeesLen2').length;
                        if(showlisttemplateContentnumbers > 0){
                            $('.showlisttemplateContent').show();
                        }else{
                            $('.showlisttemplateContent').hide();
                        }
                        
                        if($('.listInput:has(div)').length){
                            $(".adduserlist").show();
                        }else{
                            $(".adduserlist").hide();
                        }
                    }else{
                        $('.deposit').show();
                        $('input[name="deposit"]').attr("lay-verify","required");
                        $('.yudingpri').hide();
                        $('input[name="yudingpri"]').removeAttr("lay-verify");

                        $(".paymentway").show();
                        $(".renttimes").show();
                        $('input[name="endtimes"]').attr("lay-verify","required");
                        $('input[name="startimes"]').attr("lay-verify","required");
                        $(".pricemodel").show();
                        $('select[name="pricemodel"]').attr("lay-verify","required");
                        $(".huzhao").show();
                        $('.huzhao').removeAttr("lay-verify");
                        $(".usercard").show();
                        $('.usercards').removeAttr("lay-verify","identity");
                        $(".userphone").show();
                        $('.userphones').attr("lay-verify","phone");
                        $(".username").show();
                        $('.usernames').attr("lay-verify","username");
                        $('.sex').show();
                        $(".userorigin").show();
                        $('select[name="userorigin"]').attr("lay-verify","required");
                        
                        $(".useradd").show();
                        var showPricemodelContentnumbers = $('.afixFeesLen').length;
                        if(showPricemodelContentnumbers > 0){
                            $('.showPricemodelContent').show();
                        }else{
                            $('.showPricemodelContent').hide();
                        }

                        var showlisttemplateContentnumbers = $('.afixFeesLen2').length;
                        if(showlisttemplateContentnumbers > 0){
                            $('.showlisttemplateContent').show();
                        }else{
                            $('.showlisttemplateContent').hide();
                        }
                        
                        if($('.listInput:has(div)').length){
                            $(".adduserlist").show();
                        }else{
                            $(".adduserlist").hide();
                        }
                    }
                        
                    form.render();
                });

                //单图片上传
                var uploadInst1 = upload.render({
                  elem: '#test-upload-normal1'
                  ,url: '{:url("mobile/index/upload",array("id"=>$rands,"uid"=>USER_ID,"tag"=>"FRONT"))}'
                  ,before: function(obj){
                    //预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result){
                      // $('#test-upload-normal1').css('padding','10px')
                      $('#test-upload-normal1').html('<img src="' + result + '" id="remove_' + index + '" style="width:90px;height:100px;">'); //图片链接（base64）
                    });
                  }
                  ,done: function(res){
                    //如果上传失败
                    if(res.code == 1){
                        $("#chengzhuren_zhengmian").val(res.data.src);
                        idCard_shibie(url = "https://vipzu.cn/static/02.jpg", tag = "FRONT");
                        
                        layer.msg(res.msg, {icon: 1});
                    }else{
                        layer.msg(res.msg, {icon: 5});
                    }
                    //上传成功
                  }
                  ,error: function(){
                    //演示失败状态，并实现重传
                    // layer.msg("请求错误，请稍后再试", {icon: 5});
                    /*demoText.find('.demo-reload').on('click', function(){
                      uploadInst1.upload();
                    });*/
                  }
                });
                var uploadInst2 = upload.render({
                  elem: '#test-upload-normal2'
                  ,url: '{:url("mobile/index/upload",array("id"=>$rands,"uid"=>USER_ID,"tag"=>"BACK"))}'
                  ,before: function(obj){
                    //预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result){
                      // $('#test-upload-normal2').css('padding','10px')
                      $('#test-upload-normal2').html('<img src="' + result + '" id="remove_' + index + '" style="width:90px;height:100px;">'); //图片链接（base64）
                    });
                  }
                  ,done: function(res){
                    //如果上传失败
                    if(res.code == 1){
                        $("#chengzhuren_fanmian").val(res.data.src);
                        idCard_shibie(url = "https://vipzu.cn/static/01.png",tag = "BACK");
                        layer.msg(res.msg, {icon: 1});
                    }else{
                        layer.msg(res.msg, {icon: 5});
                    }
                    //上传成功
                  }
                  ,error: function(res){
                    //演示失败状态，并实现重传
                    //layer.msg("请求错误，请稍后再试", {icon: 5});
                    /*demoText.find('.demo-reload').on('click', function(){
                      uploadInst1.upload();
                    });*/
                  }
                });

                function idCard_shibie(url,tag){
                    $.post({
                        url: '{:url("Index/House/idCard")}',
                        data: {'url':url,'tag':tag},
                        success: function (idcardData) {
                            // var jsonObj = JSON.parse(res);
                            if(tag == "FRONT"){
                                if(idcardData.code == 0){
                                    $('input[name="user[0][username]"]').val(idcardData.data.name);
                                    $('input[name="user[0][usercard]"]').val(idcardData.data.idNum);
                                    $('input[name="user[0][nation]"]').val(idcardData.data.nation);
                                    $('input[name="user[0][address]"]').val(idcardData.data.address);
    
                                    if(idcardData.data.sex == '女'){
                                        $('input[name="user[0][sex]"]:last').attr('checked', 'true');
                                    }else{
                                        $('input[name="user[0][sex]"]:first').attr('checked', 'true');
                                    }
                                    form.render();
                                }
                            }else if(tag == "BACK"){
                                if(idcardData.code == 0){
                                    $('input[name="user[0][authority]"]').val(idcardData.data.authority);
                                    $('input[name="user[0][validdate]"]').val(idcardData.data.validDate);
                                    
                                }
                            }
                            
                        }
                    });
                }

                /*获取费用模板  start ===================*/
                var ids = 0;
                form.on('select(pricemodel)', function(data){
                    $('.showPricemodelContent').hide();
                    if(ids != data.value && ids != 0){
                        ids = data.value;
                        $('#guDingFree').html("");
                        $('#jiLiangFree').html("");
                        post_pricemodel();
                    }else if(data.value != "" && data.value != 0 && ids == 0){
                        ids = data.value;
                        // $('#guDingFree').html("");
                        // $('#jiLiangFree').html("");
                        post_pricemodel();
                    }else if(ids == data.value && ids != 0){
                        ids = data.value;
                        $('#guDingFree').html("");
                        $('#jiLiangFree').html("");
                        post_pricemodel();
                    }else{
                        layer.msg('请选择费用模板', {icon: 5});
                        $('.showPricemodelContent').hide();
                    }
                    
                });
                function post_pricemodel(){
                    $.post({
                        url: '{:url("Index/House/findmodelName")}',
                        data: {'id':ids},
                        success: function (data) {
                            var jsonObj = JSON.parse(data);
                            // console.log(jsonObj['afixFees']);
                            if(jsonObj){
                                $.each(jsonObj['afixFees'], function(index,item){
                                    var html = '<div class="layui-form-item afixFeesLen">\
                                                <label class="layui-form-label">'+item.name+'</label>\
                                                <div class="layui-input-inline">\
                                                  <input type="hidden" required  lay-verify="required" name="model[afixFees]['+index+'][name]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.name+'">\
                                                  <input type="number" lay-verify="required" name="model[afixFees]['+index+'][money]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.money+'">\
                                                  <input type="hidden" required  lay-verify="required" name="model[afixFees]['+index+'][unit]" placeholder="'+item.unit+'" autocomplete="off" class="layui-input" value="'+item.unit+'">\
                                                </div>\
                                                <div class="layui-form-mid layui-word-aux">'+item.unit+'</div>\
                                            </div>'
                                    $('#guDingFree').append(html);
                                })
                                $.each(jsonObj['computedFees'], function(index,item){
                                    var html = '<div class="layui-form-item">\
                                                <label class="layui-form-label">'+item.name+'</label>\
                                                <div class="layui-input-inline">\
                                                  <input type="hidden" required  lay-verify="required" name="model[computedFees]['+index+'][name]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.name+'">\
                                                  <input type="number" required  lay-verify="required" name="model[computedFees]['+index+'][money]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.money+'">\
                                                  <input type="hidden" required  lay-verify="required" name="model[computedFees]['+index+'][unit]" placeholder="'+item.unit+'" autocomplete="off" class="layui-input" value="'+item.unit+'">\
                                                </div>\
                                                <div class="layui-form-mid layui-word-aux">'+item.unit+'</div>\
                                            </div>'
                                    // $('#jiLiangFree').append(html);
                                })
                                $('.showPricemodelContent').show();
                            }else{
                                $('.showPricemodelContent').hide();
                                layer.msg('该模板费用为空，请先在系统配置中完成配置', {icon: 5});
                            }
                        }
                    });
                }
                /*获取费用模板  end ===================*/

                /*获取清单模板  start ===================*/
                var ids = 0;
                form.on('select(listtemplate)', function(data){
                    $('.showlisttemplateContent').hide();
                    if(ids != data.value && ids != 0){
                        ids = data.value;
                        $('#guDingFree2').html("");
                        $('#jiLiangFree2').html("");
                        post_listtemplate();
                    }else if(data.value != "" && data.value != 0 && ids == 0){
                        ids = data.value;
                        // $('#guDingFree').html("");
                        // $('#jiLiangFree').html("");
                        post_listtemplate();
                    }else if(ids == data.value && ids != 0){
                        ids = data.value;
                        $('#guDingFree2').html("");
                        $('#jiLiangFree2').html("");
                        post_listtemplate();
                    }else{
                        layer.msg('请选择清单模板', {icon: 5});
                        $('.showlisttemplateContent').hide();
                    }
                    
                }); 

                function post_listtemplate(){
                    $.post({
                        url: '{:url("Index/House/findlisttemplateName")}',
                        data: {'id':ids},
                        success: function (data) {
                            var jsonObj = JSON.parse(data);
                            // console.log(jsonObj['afixFees']);
                            if(jsonObj){
                                $.each(jsonObj['afixFees'], function(index,item){
                                    var html = '<div class="layui-form-item afixFeesLen2">\
                                                <label class="layui-form-label">'+item.name+'</label>\
                                                <div class="layui-input-inline">\
                                                  <input type="hidden" required  lay-verify="required" name="listtemplate[afixFees]['+index+'][name]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.name+'">\
                                                  <input type="number" lay-verify="required" name="listtemplate[afixFees]['+index+'][money]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.money+'">\
                                                  <input type="hidden" required  lay-verify="required" name="listtemplate[afixFees]['+index+'][unit]" placeholder="'+item.unit+'" autocomplete="off" class="layui-input" value="'+item.unit+'">\
                                                </div>\
                                                <div class="layui-form-mid layui-word-aux">'+item.unit+'</div>\
                                            </div>'
                                    $('#guDingFree2').append(html);
                                })
                                $.each(jsonObj['computedFees'], function(index,item){
                                    var html = '<div class="layui-form-item">\
                                                <label class="layui-form-label">'+item.name+'</label>\
                                                <div class="layui-input-inline">\
                                                  <input type="hidden" required  lay-verify="required" name="listtemplate[computedFees]['+index+'][name]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.name+'">\
                                                  <input type="number" required  lay-verify="required" name="listtemplate[computedFees]['+index+'][money]" placeholder="'+item.name+'" autocomplete="off" class="layui-input" value="'+item.money+'">\
                                                  <input type="hidden" required  lay-verify="required" name="listtemplate[computedFees]['+index+'][unit]" placeholder="'+item.unit+'" autocomplete="off" class="layui-input" value="'+item.unit+'">\
                                                </div>\
                                                <div class="layui-form-mid layui-word-aux">'+item.unit+'</div>\
                                            </div>'
                                    // $('#jiLiangFree').append(html);
                                })
                                $('.showlisttemplateContent').show();
                            }else{
                                $('.showlisttemplateContent').hide();
                                layer.msg('该模板为空，请先在系统配置中完成配置', {icon: 5});
                            }
                        }
                    });
                }
                /*获取清单模板  end ===================*/

                //监听提交
                form.on('submit(subs)', function(data){
                    $('#subs').attr('disabled','disabled');
                    var form = $("#form").serializeArray();
                    var statesh = data.field.housestate;
                    if(data.field.housestate == '在租'){
                        layer.open({
                            type:1
                            ,content: '<div style="padding: 20px 100px;">请仔细检查 租赁时间 是否选择正确，添加后如有付费则无法进行修改</div>'
                            ,btn: ['确认无误', '再看一下']
                            ,btnAlign: 'c' //按钮居中
                            ,shade: 0 //不显示遮罩
                            ,yes: function(index, layero){
                                //按钮【按钮一】的回调
                                $.post({
                                    url: '{:url("addRent")}',
                                    data: form,
                                    success: function (data) {
                                        var jsonObj = JSON.parse(data);
                                        console.log(jsonObj.code);
                                        if(jsonObj.code == 1){
                                            layer.msg(jsonObj.msg, {icon: 1});
                                            if(statesh == '空置'){
                                                $('input[name="housestate"]:last').attr('checked', 'true');
                                            }
                                            $('.showPricemodelContent').hide();
                                            $('#guDingFree').html("");
                                            $('#jiLiangFree').html("");
                                            var index = parent.layer.open({
                                              type: 2,
                                              area: ['1000px', '100vh'],
                                              maxmin: true,
                                              content: "{:url('houseDetail')}?uuid="+jsonObj.data 
                                            });
                                            parent.layer.full(index);
                                        }else{
                                            layer.msg(jsonObj.msg, {icon: 5});
                                        }
                                        $('#subs').removeAttr('disabled');
                                    },
                                    error: function(){
                                        $('#subs').removeAttr('disabled');
                                    }
                                });
                                layer.close(index);
                                return false;
                            }
                            ,btn2: function(index, layero){
                                //按钮【按钮二】的回调
                                $('#subs').removeAttr('disabled');
                                //return false 开启该代码可禁止点击该按钮关闭
                            }
                        })
                    }else{
                        $.post({
                            url: '{:url("rz")}',
                            data: form,
                            success: function (data) {
                                var jsonObj = JSON.parse(data);
                                console.log(jsonObj.code);
                                if(jsonObj.code == 1){
                                    layer.msg(jsonObj.msg, {icon: 1});
                                    //location.reload();
                                    //$("#resets").click();
                                    if(statesh == '空置'){
                                        $('input[name="housestate"]:last').attr('checked', 'true');
                                    }
                                    $('.showPricemodelContent').hide();
                                    $('#guDingFree').html("");
                                    $('#jiLiangFree').html("");
                                }else{
                                    layer.msg(jsonObj.msg, {icon: 5});
                                }
                                $('#subs').removeAttr('disabled');
                            },
                            error: function(){
                                $('#subs').removeAttr('disabled');
                            }
                        }); 
                    }
                    return false;
                });
            });
            

      </script>
    </body>
    

</html>